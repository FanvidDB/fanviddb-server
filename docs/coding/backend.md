---
layout: default
title: Backend
---

# Backend

The backend uses [FastAPI](fastapi.tiangolo.com/), an async [Python](https://www.python.org/) API framework, and uses [SQLAlchemy](https://www.sqlalchemy.org/) for database interactions.

<div class="alert alert-info" role="alert">
  The instructions on this page assume that you are familiar with GitHub and the command line.
  If you are not but want to be, check out <a href="https://lab.github.com/githubtraining/first-day-on-github">First Day On Github</a>!
</div>

## Setup (Mac OS)

### Fork & clone the repository

First, create a fork of [github.com/FanvidDB/fanviddb-server](https://github.com/FanvidDB/fanviddb-server) that you can clone.

```bash
git clone git@github.com:your-username/fanviddb-server.git
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Create `.env` file

From the root of the repository, run the following:

```
cat << EOF  > .env
DATABASE_URL="postgresql://postgres:postgres@localhost/fanviddb"
AUTH_SECRET_KEY="secret"
EMAIL_TOKEN_SECRET_KEY="secret"
EOF
```

This will create a `.env` file with the basic configuration needed by the app.

### Database configuration

1. Install [Postgres.app](https://postgresapp.com/)
2. Open Postgres.app and double-click on the `postgres` database
3. Run `CREATE DATABASE fanviddb;` in the terminal that opens to create a database called `fanviddb`.
4. Run `alembic upgrade head` to create the database tables that the application needs.

## Running the server

```
uvicorn fanviddb.api:app --reload
```

This will automatically reload the server when your code changes.

You can run the backend on its own without the frontend, and interact with the Swagger UI at <http://127.0.0.1:8000/docs/>. If you want to build the frontend as well, you can either [build it once or automatically reload when javascript changes](/coding/frontend.html), whichever you prefer.

## Adding translatable strings

We use [Fluent](https://projectfluent.org/) to handle translations, because we believe it provides the best experience for non-technical translators of the currently-available options. Although most user-visible text will be in Javascript on the [frontend](/coding/frontend.html), there are some strings (like error messages or email content) that are generated by the backend.

Any time you add a string that will be displayed to an end user, be sure to create a new message ID and translation in `locale/en-US/python.ftl` (and any other locales you want to support off the bat) and then call Fluent with that message ID to get the appropriate translation. For example:

```ftl
# locale/en-US/python.ftl
hello-world = Hello World!
```

```python
# router.py
from fanviddb.i18n.utils import fluent_dependency

@api.get("/path/to/endpoint")
async def endpoint(fluent: FluentLocalization = Depends(fluent_dependency)):
    return {"message": fluent.format_value("hello-world")}
```

`fluent_dependency` is a [FastAPI dependency](https://fastapi.tiangolo.com/tutorial/dependencies/).
It will make the API endpoint take a `locales` query parameter, which is used to initialize Fluent.
If you aren't working on an API endpoint, you can instead do something like this:

```python
from fanviddb.i18n.utils import get_fluent
from fanviddb.email import send_email

def send_email_without_api_request():
	# Translations will be looked up in each locale in order until a translation is found.
	locales = determine_locales_somehow()
	fluent = get_fluent(locales)
	send_email(
		from_email="from@example.com",
		to_emails=["to@example.com"],
		subject=fluent.format_value("email-hello-world-subject"),
		content=fluent.format_value("email-hello-world-content")
	)
```

Check out [Fluent's Good Practices for Developers](https://github.com/projectfluent/fluent/wiki/Good-Practices-for-Developers) and the [Fluent Syntax Guide](https://projectfluent.org/fluent/guide/) for more information.

## Running tests

Tests use [the pytest framework](https://docs.pytest.org/) and can be run with the following command:

```bash
pytest
```

## Before you push new code

If you make changes to the backend code, make sure to run the following commands prior to creating a pull request:

```bash
pytest    # Runs python tests
make fmt  # Auto-enforces code style
make lint # Checks code style
```

## Autogenerated migrations

For simple migrations, you can [automatically generate them with alembic](https://alembic.sqlalchemy.org/en/latest/autogenerate.html):

```
alembic revision --autogenerate -m "brief description"
```

Once generated, migrations can be applied with `alembic upgrade head`.
