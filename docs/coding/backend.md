---
layout: default
title: Backend
---

# Backend

<div class="alert alert-info" role="alert">
  The instructions on this page assume that you are familiar with GitHub and the command line.
  If you are not but want to be, check out <a href="https://lab.github.com/githubtraining/first-day-on-github">First Day On Github</a>!
</div>

## Setup (Mac OS)

### Fork & clone the repository

First, visit [github.com/FanvidDB/fanviddb-server](https://github.com/FanvidDB/fanviddb-server) and click on "Fork" to create a fork of the repository. Once you have a fork, you can clone it.

```bash
git clone git@github.com:your-username/fanviddb-server.git
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Create `.env` file

From the root of the repository, run the following:

```
cat << EOF  > .env
DATABASE_URL="postgresql://postgres:postgres@localhost/fanviddb"
AUTH_SECRET_KEY="secret"
EMAIL_TOKEN_SECRET_KEY="secret"
EOF
```

This will create a `.env` file with the basic configuration needed by the app.

### Database configuration
1. Install [Postgres.app](https://postgresapp.com/)
2. Open Postgres.app and double-click on the `postgres` database
3. Run `CREATE DATABASE fanviddb;` in the terminal that opens to create a database called `fanviddb`.
4. Run `alembic upgrade head` to create the database tables that the application needs.

## Running the server

```
uvicorn fanviddb.api:app --reload
```

This will automatically reload the server when your code changes.

## Marking strings for translation

Any time that you add a hard-coded user-facing string, make sure it is marked for translation with gettext.

```python
from gettext import gettext as _

@api.get("/path/to/endpoint")
async def endpoint():
    return {"message": _("Hello world")}
```

Most of the user interface is generated by the front-end; however, any emails sent by the backend and any error messages returned to the user should be marked for translation.

Check out [CKAN's general guidelines](https://docs.ckan.org/en/2.9/contributing/string-i18n.html#general-guidelines-for-internationalizing-strings) on how to mark strings for translation; they will make things much easier for translators.

Once you have finished marking your strings, run the following command to extract them and add them to all existing locales:

```
make extract
```

## Before you push new code

If you make changes to the backend code, make sure to run the following commands prior to creating a pull request:

```bash
pytest    # Runs python tests
make fmt  # Auto-enforces some code style
make lint # Checks code style
```

## Autogenerated migrations

For simple migrations, you can [automatically generate them with alembic](https://alembic.sqlalchemy.org/en/latest/autogenerate.html):

```
alembic revision --autogenerate -m "brief description"
```

Once generated, migrations can be applied with `alembic upgrade head`.

## Adding a new locale

The following command will set up the requested locale.

```bash
make locale-init locale=en_GB
```
